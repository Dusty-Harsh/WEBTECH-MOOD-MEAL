<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MoodPlate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* A funky, food-inspired theme! */
        body { 
            font-family: 'Nunito', sans-serif; 
            background-color: #FFFBEB; /* Vanilla Cream */
        }
        :root {
            --c-text: #44403C; /* Dark Chocolate */
            --c-primary: #84CC16; /* Lime Green */
            --c-secondary: #EF4444; /* Tomato Red */
            --c-background: #FFFBEB; /* Vanilla Cream */
            --c-surface: #FFFFFF;
        }
        .mood-btn { 
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); 
            border: 2px solid transparent;
        }
        .mood-btn:hover {
            transform: translateY(-6px) scale(1.05);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
        }
        .mood-btn.stressed:hover { border-color: #F87171; }
        .mood-btn.tired:hover   { border-color: #60A5FA; }
        .mood-btn.happy:hover   { border-color: #FBBF24; }
        .mood-btn.focused:hover { border-color: #A78BFA; }

        .funky-button {
            background-color: var(--c-primary);
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 0 #65A30D; /* Darker lime for shadow */
        }
        .funky-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #65A30D;
        }
        .funky-button:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #65A30D;
        }
        .funky-logout {
            color: var(--c-secondary);
        }
        .funky-logout:hover {
            text-decoration: underline;
        }
        .recipe-card {
            border-left: 6px solid var(--c-primary);
        }
    </style>
</head>
<body class="text-stone-800">

    <script>
        if (!localStorage.getItem('moodplate_token')) {
            const currentPath = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
            window.location.href = `${currentPath}/login.html`;
        }
    </script>

    <div class="container mx-auto px-4 py-8 md:py-12">
        
        <header class="text-center mb-10">
            <div class="flex justify-between items-center mb-6 p-4 bg-lime-400 rounded-xl shadow-lg">
                 <h1 class="text-2xl md:text-3xl font-extrabold text-white tracking-wider">MoodPlate</h1>
                 <button id="logout-btn" class="text-sm font-bold text-white hover:text-lime-800 transition">Logout</button>
            </div>
        </header>

        <section id="mood-selector" class="mb-12 max-w-2xl mx-auto">
            <form id="mood-form" class="text-center">
                <label for="mood-input" id="welcome-message" class="block text-2xl font-bold mb-4">How are you feeling today?</label>
                <div class="flex items-center gap-2 p-2 bg-white rounded-full shadow-inner">
                    <input type="text" id="mood-input" placeholder="e.g., adventurous, calm, curious..." class="w-full px-4 py-2 text-lg bg-transparent focus:outline-none">
                    <button type="submit" class="funky-button text-white font-bold py-2 px-6 rounded-full">Get Meal</button>
                </div>
            </form>
             <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mt-6">
                <button data-mood="stressed" class="mood-btn stressed flex flex-col items-center p-4 bg-white rounded-xl shadow-md"><span class="text-4xl">ðŸ˜©</span><span class="mt-2 font-semibold">Stressed</span></button>
                <button data-mood="tired" class="mood-btn tired flex flex-col items-center p-4 bg-white rounded-xl shadow-md"><span class="text-4xl">ðŸ˜´</span><span class="mt-2 font-semibold">Tired</span></button>
                <button data-mood="happy" class="mood-btn happy flex flex-col items-center p-4 bg-white rounded-xl shadow-md"><span class="text-4xl">ðŸ˜Š</span><span class="mt-2 font-semibold">Happy</span></button>
                <button data-mood="focused" class="mood-btn focused flex flex-col items-center p-4 bg-white rounded-xl shadow-md"><span class="text-4xl">ðŸŽ¯</span><span class="mt-2 font-semibold">Focused</span></button>
            </div>
        </section>

        <main id="results-container" class="max-w-4xl mx-auto space-y-12">
            <div id="recommendations-section">
                 <div id="loading" class="text-center hidden"><p class="font-bold text-lg">Stirring up some ideas...</p></div>
                 <div id="recommendations"></div>
            </div>
            
            <div id="history-section">
                <h2 class="text-2xl font-bold text-center mb-6">Your Food Journal</h2>
                <div id="history-list" class="space-y-4">
                    </div>
            </div>
        </main>
        
    </div>

    <script>
        // --- DOM Elements ---
        const welcomeMessage = document.getElementById('welcome-message');
        const logoutBtn = document.getElementById('logout-btn');
        const moodForm = document.getElementById('mood-form');
        const moodInput = document.getElementById('mood-input');
        const moodButtons = document.querySelectorAll('.mood-btn');
        const recommendationsDiv = document.getElementById('recommendations');
        const historyListDiv = document.getElementById('history-list');
        const loadingDiv = document.getElementById('loading');
        
        // --- API & Auth ---
        const API_URL = 'http://localhost:3000/api';
        const token = localStorage.getItem('moodplate_token');
        const userName = localStorage.getItem('moodplate_userName');

        // --- Page Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (userName) {
                welcomeMessage.textContent = `Hey ${userName}, how are you feeling today?`;
            }
            loadHistory();
        });
        
        // --- Event Listeners ---
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('moodplate_token');
            localStorage.removeItem('moodplate_userName');
            const currentPath = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
            window.location.href = `${currentPath}/login.html`;
        });

        // Form submission for typed input
        moodForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const mood = moodInput.value.trim();
            if(mood) {
                getRecommendations(mood);
            }
        });

        // Buttons now populate the input field
        moodButtons.forEach(button => {
            button.addEventListener('click', () => {
                const mood = button.dataset.mood;
                moodInput.value = mood;
                getRecommendations(mood);
            });
        });

        // --- API Call Functions ---
        async function fetchAPI(endpoint, options = {}) {
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
            options.headers = { ...defaultHeaders, ...options.headers };
            const response = await fetch(`${API_URL}${endpoint}`, options);
            if (response.status === 401 || response.status === 403) {
                logoutBtn.click();
            }
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'An API error occurred.');
            }
            return response.json();
        }
        
        async function getRecommendations(mood) {
            loadingDiv.classList.remove('hidden');
            recommendationsDiv.innerHTML = '';
            try {
                // We'll default to 'happy' if the custom mood isn't found, just to show something.
                const data = await fetchAPI(`/recommendations/${mood.toLowerCase()}`).catch(err => fetchAPI(`/recommendations/happy`));
                displayRecommendations(data, mood);
            } catch (error) {
                displayError(recommendationsDiv, error.message);
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        async function loadHistory() {
            try {
                const history = await fetchAPI('/history');
                displayHistory(history);
            } catch (error) {
                displayError(historyListDiv, 'Could not load your meal history.');
            }
        }

        async function saveToHistory(mood, recipeTitle) {
            try {
                await fetchAPI('/history', {
                    method: 'POST',
                    body: JSON.stringify({ mood, recipeTitle })
                });
                loadHistory(); 
            } catch (error) {
                alert('Could not save to history.');
            }
        }

        // --- Display Functions ---
        function displayRecommendations(data, mood) {
            let html = `<div class="mb-6 text-center p-4 bg-amber-100 text-amber-800 rounded-lg shadow"><p class="font-semibold">For a <span class="font-bold">${mood}</span> mood: ${data.description}</p></div><div class="space-y-8">`;
            data.recipes.forEach(recipe => {
                html += `
                    <div class="recipe-card bg-white rounded-xl shadow-lg overflow-hidden md:flex">
                        <img class="h-48 w-full object-cover md:h-auto md:w-1/3" src="${recipe.image}" alt="${recipe.title}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/FFFFFF?text=Image+Not+Found';">
                        <div class="p-6 md:w-2/3 flex flex-col justify-between">
                            <div>
                                <h3 class="text-2xl font-bold mb-2 text-stone-800">${recipe.title}</h3>
                                <div class="mb-4">
                                    <h4 class="font-semibold text-lime-700">Ingredients:</h4>
                                    <ul class="list-disc list-inside text-stone-600 text-sm">${recipe.ingredients.map(ing => `<li>${ing}</li>`).join('')}</ul>
                                </div>
                                <p class="text-stone-600 text-sm"><strong>Instructions:</strong> ${recipe.instructions}</p>
                            </div>
                            <button onclick="saveToHistory('${mood}', '${recipe.title.replace(/'/g, "\\'")}')" class="mt-4 w-full md:w-auto self-end funky-button text-white font-bold py-2 px-4 rounded-full">Add to Journal</button>
                        </div>
                    </div>`;
            });
            html += `</div>`;
            recommendationsDiv.innerHTML = html;
        }

        function displayHistory(history) {
            if (history.length === 0) {
                historyListDiv.innerHTML = `<div class="text-center text-stone-500 p-6 bg-white rounded-lg shadow-sm">Your food journal is empty. Pick a mood to get started!</div>`;
                return;
            }
            historyListDiv.innerHTML = history.map(entry => `
                <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center border-l-4 border-amber-400">
                    <div>
                        <p class="font-semibold">${entry.recipeTitle}</p>
                        <p class="text-sm text-stone-600">You felt: <span class="font-medium capitalize text-lime-700">${entry.mood}</span></p>
                    </div>
                    <p class="text-xs text-stone-500">${new Date(entry.date).toLocaleDateString()}</p>
                </div>
            `).join('');
        }
        
        function displayError(element, message) {
             element.innerHTML = `<div class="text-center p-4 bg-red-100 text-red-700 rounded-lg shadow"><p>${message}</p></div>`;
        }
    </script>
</body>
</html>